// Generated by CoffeeScript 1.12.7
(function() {
  var SessionStore, app, authCheck, bodyparser, db, express, level, levelws, metrics, morgan, session, user, user_router;

  express = require('express');

  bodyparser = require('body-parser');

  morgan = require('morgan');

  session = require('express-session');

  SessionStore = require('level-session-store')(session);

  level = require('level');

  levelws = require('level-ws');

  db = levelws(level(__dirname + "/../db"));

  metrics = require('./metrics')(db);

  user = require('./user')(db);

  app = express();

  app.set('port', '8888');

  app.set('views', __dirname + "/../views");

  app.set('view engine', 'pug');

  app.use(bodyparser.json());

  app.use(bodyparser.urlencoded());

  app.use(morgan('dev'));

  app.use(session({
    secret: "simple secret",
    store: new SessionStore('./db/sessions'),
    resave: true,
    saveUnitialized: true
  }));

  authCheck = function(req, res, next) {
    console.log(req.session);
    if (req.session.loggedIn !== true) {
      return res.redirect('/auth');
    } else {
      return next();
    }
  };

  app.use('/', express["static"](__dirname + "/../public"));

  app.get('/', authCheck, function(req, res) {
    return res.render('index', {
      text: "Hello " + req.session.username + " !"
    });
  });

  app.get('/hello/:name', function(req, res) {
    return res.send("Hello " + req.params.name);
  });

  app.get('/auth', function(req, res) {
    return res.render('auth');
  });

  app.post('/auth', function(req, res) {
    var password, ref, username;
    ref = req.body, username = ref.username, password = ref.password;
    return user.get(username, password, function(err, user) {
      if (err) {
        throw next(err);
      }
      if (password !== user.password) {
        return res.redirect('/auth');
      } else {
        if (req.session == null) {
          req.session = {};
        }
        req.session.loggedIn = true;
        req.session.username = user.username;
        console.log(req.session);
        return res.redirect('/');
      }
    });
  });

  app.get('/logout', function(req, res) {
    req.session.destroy();
    console.log(req.session);
    return res.redirect('/auth');
  });

  app.get('/metrics.json', function(req, res) {
    return metrics.get(req.params.metrics, req.session.username, function(err, data) {
      if (err) {
        throw next(err);
      }
      if (data === null) {
        return res.status(404).json('Data not found');
      } else {
        return res.status(200).json(data);
      }
    });
  });

  app.post('/metrics.json/:id', function(req, res) {
    return metrics.save(req.params.id, req.body, function(err) {
      if (err) {
        throw next(err);
      }
      return res.status(200).send('metrics saved');
    });
  });

  user_router = express.Router();

  user_router.get('/user/:username', function(req, res) {
    return user.get(req.params.username, function(err, user) {
      if (err) {
        throw next(err);
      }
      if (user === null) {
        return res.status(404).send("user not found");
      } else {
        return res.status(200).json(user);
      }
    });
  });

  user_router.post('/user', function(req, res) {
    var email, password, ref, username;
    ref = req.body, username = ref.username, password = ref.password, email = ref.email;
    return user.save(username, password, email, function(err) {
      if (err) {
        throw next(err);
      }
      res.status(200).send("user saved");
      return console.log(res.session);
    });
  });

  app.use(user_router);

  app.listen(app.get('port'), function() {
    return console.log("Server listening on " + (app.get('port')) + " !");
  });

}).call(this);
